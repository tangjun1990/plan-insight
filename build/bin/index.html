<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¡ç¾æµ‹è¯•</title>
    <!-- å¼•å…¥å¾®ä¿¡JS-SDK -->
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        body {
            background-color: #f7f7f7;
            color: #333;
            line-height: 1.5;
        }

        .container {
            max-width: 375px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .nav-bar {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 375px;
            height: 44px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            font-size: 17px;
            font-weight: 500;
            border-bottom: 1px solid #eee;
            z-index: 100;
        }

        .nav-bar .nav-left {
            position: absolute;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-bar .back {
            color: #576b95;
            font-size: 14px;
            cursor: pointer;
        }

        .nav-bar .prev {
            color: #576b95;
            font-size: 14px;
            cursor: pointer;
        }

        #page-title {
            text-align: center;
            flex: 1;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar {
            position: fixed;
            top: 44px;
            width: 100%;
            max-width: 375px;
            height: 2px;
            background: #eee;
            z-index: 99;
        }

        .progress {
            height: 100%;
            background: #07c160;
            width: 25%;
            transition: width 0.3s;
        }

        /* ä¸»é¡µé¢æ ·å¼ */
        .page {
            padding: 60px 16px 16px;
            display: none;
            padding-bottom: 80px;
        }

        .page.active {
            display: block;
        }

        .page-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 24px;
            text-align: center;
        }

        .page-subtitle {
            font-size: 14px;
            color: #999;
            text-align: center;
            margin-bottom: 32px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            background: #fff;
        }

        /* è¡¨å•éªŒè¯æ ·å¼ */
        .form-error {
            color: #ff4d4f;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .form-input.error {
            border-color: #ff4d4f;
        }

        .form-input.error:focus {
            border-color: #ff4d4f;
            box-shadow: 0 0 0 2px rgba(255, 77, 79, 0.2);
        }

        /* é¢œè‰²é€‰æ‹©å™¨æ ·å¼ */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .color-item {
            position: absolute;
            width: 28px;        /* å‡å°é¢œè‰²å—å°ºå¯¸ */
            height: 28px;       /* å‡å°é¢œè‰²å—å°ºå¯¸ */
            border-radius: 6px; /* é€‚å½“å‡å°åœ†è§’ */
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            z-index: 1;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
            margin: 3px;        /* å‡å°å¤–è¾¹è· */
        }

        .color-item.selected-like {
            border-color: #07c160;
            box-shadow: 0 0 15px #07c160, 0 0 20px #07c160 !important;
            z-index: 5;
        }

        .color-item.selected-dislike {
            border-color: #ff4d4f;
            box-shadow: 0 0 15px #ff4d4f, 0 0 20px #ff4d4f !important;
            z-index: 5;
        }

        .color-item:hover::before {
            
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }

        .color-item:hover::after {
            content: attr(data-name);
            position: absolute;
            bottom: -48px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
        }

        /* å½¢å®¹è¯é€‰æ‹©å™¨æ ·å¼ */
        .adjective-list {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            margin-top: 12px;
        }

        .adjective-item {
            padding: 6px 8px;
            background: #f7f7f7;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .adjective-item.selected {
            background: #07c160;
            color: #fff;
        }

        /* å›¾ç‰‡é€‰æ‹©å™¨æ ·å¼ */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            padding: 4px;
        }

        .image-item {
            aspect-ratio: 1;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-item.selected {
            border-color: #07c160;
        }

        .image-item:hover .image-preview-btn {
            opacity: 1;
        }

        .image-preview-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 32px;
            margin-bottom: 16px;
        }

        .btn-primary {
            background: #07c160;
            color: #fff;
            border: none;
        }

        .btn-secondary {
            background: #f7f7f7;
            color: #07c160;
            border: none;
        }

        /* åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
        .tab-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 375px;
            height: 50px;
            background: #fff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #eee;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #999;
            font-size: 10px;
        }

        .tab-item.active {
            color: #07c160;
        }

        .tab-item i {
            font-size: 24px;
            margin-bottom: 2px;
        }

        /* æŠ¥å‘Šé¡µé¢æ ·å¼ */
        .report-section {
            padding: 0 16px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px 0;
            border-bottom: 1px solid #eee;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }

        .user-meta {
            font-size: 14px;
            color: #999;
        }

        .report-date {
            font-size: 14px;
            color: #999;
        }

        .report-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .report-card-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #07c160;
        }

        .report-card-content {
            font-size: 14px;
            color: #666;
        }

        .color-analysis {
            margin-bottom: 20px;
        }

        .analysis-section {
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            color: #333;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .color-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .color-tag {
            padding: 6px 12px;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
        }

        .style-analysis {
            margin-bottom: 20px;
        }

        .selected-adjectives {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .adjective-tag {
            padding: 6px 12px;
            background: #f0f9eb;
            color: #07c160;
            border-radius: 4px;
            font-size: 13px;
        }

        .visual-analysis {
            margin-bottom: 20px;
        }

        .selected-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .image-preview {
            text-align: center;
        }

        .image-preview img {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .image-label {
            font-size: 13px;
            color: #999;
        }

        .summary-points .point img {
            width: 100%;
            aspect-ratio: 1;
            text-align: center;
            padding: 0;
            margin: 0;
        }

        .point {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #333;
        }

        .point i {
            color: #07c160;
        }

        .analysis-text {
            line-height: 1.6;
            font-size: 14px;
            color: #666;
        }

        .report-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            margin-bottom: 32px;
        }

        .report-actions .btn {
            flex: 1;
            margin: 0;
        }

        /* é¢œè‰²ç­›é€‰æ ·å¼ */
        .color-filter {
            margin-bottom: 16px;
        }

        .search-box {
            position: relative;
            margin-bottom: 12px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .color-categories {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .category-tag {
            padding: 4px 12px;
            background: #f7f7f7;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            cursor: pointer;
        }

        .category-tag.active {
            background: #07c160;
            color: #fff;
        }

        /* é¢œè‰²é€‰æ‹©åŒºåŸŸæ ·å¼ */
        .color-selection-area {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
            -webkit-overflow-scrolling: touch;
            position: relative;
            background-color: #fff;
            border-radius: 8px;
        }
        
        /* é¢œè‰²é€‰æ‹©æ¨¡å¼æŒ‰é’®æ ·å¼ */
        .color-selection-mode {
            display: flex;
            position: sticky;
            top: 60px;
            z-index: 50;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        
        .mode-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #f5f5f5;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: #e6f7ff;
            color: #1890ff;
            font-weight: 500;
        }
        
        .like-mode.active {
            background: #f0f9eb;
            color: #07c160;
        }
        
        .dislike-mode.active {
            background: #fff2f0;
            color: #ff4d4f;
        }
        
        .mode-icon {
            font-size: 16px;
            margin-right: 6px;
        }
        
        .mode-text {
            white-space: nowrap;
        }
        
        .mode-icon {
            font-size: 16px;
            margin-right: 6px;
        }

        .color-grid {
            display: block;
            position: relative;
            height: auto;
            min-height: 250px;  /* å‡å°æœ€å°é«˜åº¦ */
            padding: 10px;      /* å‡å°å†…è¾¹è· */
            background: #f7f7f7;
        }

        .color-item {
            position: absolute;
            width: 28px;        /* å‡å°é¢œè‰²å—å°ºå¯¸ */
            height: 28px;       /* å‡å°é¢œè‰²å—å°ºå¯¸ */
            border-radius: 6px; /* é€‚å½“å‡å°åœ†è§’ */
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            z-index: 1;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
            margin: 3px;        /* å‡å°å¤–è¾¹è· */
        }

        .color-item:hover {
            transform: scale(1.4); /* å‡å°æ‚¬åœæ—¶çš„æ”¾å¤§æ¯”ä¾‹ */
            z-index: 10;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .color-item.selected-like {
            border-color: #07c160;
            box-shadow: 0 0 5px #07c160 !important;
            z-index: 5;
        }

        .color-item.selected-dislike {
            border-color: #ff4d4f;
            box-shadow: 0 0 5px #ff4d4f !important;
            z-index: 5;
        }

        .color-item:hover::after {
            content: attr(data-name);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
        }

        /* å·²é€‰é¢œè‰²å±•ç¤ºæ ·å¼ */
        .selected-colors {
            background: #f7f7f7;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .selected-colors-title {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
        }

        .selected-colors-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .selected-color-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #fff;
            border-radius: 4px;
            font-size: 12px;
        }

        .selected-color-preview {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }

        .remove-color {
            color: #999;
            cursor: pointer;
        }

        /* å›¾ç‰‡ç±»åˆ«é€‰æ‹©æ ·å¼ */
        .image-categories {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .category-tab {
            padding: 8px 16px;
            background: #f7f7f7;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            cursor: pointer;
        }

        .category-tab.active {
            background: #07c160;
            color: #fff;
        }

        /* å›¾ç‰‡é€‰æ‹©åŒºåŸŸæ ·å¼ */
        .image-selection-area {
            margin-bottom: 16px;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            padding: 4px;
        }

        .image-item {
            aspect-ratio: 1;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-item.selected {
            border-color: #07c160;
        }

        .image-item:hover .image-preview-btn {
            opacity: 1;
        }

        .image-preview-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        /* å·²é€‰å›¾ç‰‡å±•ç¤ºæ ·å¼ */
        .selected-images-summary {
            background: #f7f7f7;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .selected-images-title {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
        }

        .selected-images-list {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .selected-image-item {
            flex: 0 0 80px;
            position: relative;
        }

        .selected-image-item img {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            object-fit: cover;
        }

        .selected-image-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            text-align: center;
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ff4d4f;
            border-radius: 10px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }

        /* æŒ‰é’®ç»„æ ·å¼ */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            margin-bottom: 16px;
        }

        .btn-group .btn {
            flex: 1;
            margin: 0;
        }

        /* æŠ¥å‘Šé¡µé¢ä¸­çš„å›¾ç‰‡å±•ç¤ºæ ·å¼ */
        .visual-analysis {
            width: 100%;
            padding: 0;
            margin: 0;
        }

        .visual-analysis .image-preview {
            width: 100%;
            aspect-ratio: 1;
            text-align: center;
            padding: 0;
            margin: 0;
        }

        .visual-analysis .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 4px;
            display: block;
        }

        .visual-analysis .image-label {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
            word-break: keep-all;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 2px;
        }

        /* æŠ¥å‘ŠåŠ¨ç”»åŒºåŸŸæ ·å¼ */
        .report-animation {
            width: 100%;
            height: 250px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        #color-animation-container {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .animation-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            color: #07c160;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <div class="nav-bar">
            <div class="nav-left">
                <span class="back" id="back-btn" style="display: none;">è¿”å›</span>
                <span class="prev" id="prev-btn" style="display: none;">ä¸Šä¸€æ­¥</span>
            </div>
            <span id="page-title">å®¡ç¾æµ‹è¯•</span>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>

        <!-- æ­¥éª¤1ï¼šä¸ªäººä¿¡æ¯ -->
        <div class="page active" id="step1-page">
            <div class="page-title">ç¬¬ä¸€æ­¥ï¼šå¡«å†™ä¸ªäººä¿¡æ¯</div>
            <div class="page-subtitle">è¯·å¡«å†™æ‚¨çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°äº†è§£æ‚¨</div>
            <div class="form-group">
                <label class="form-label">å§“å</label>
                <input type="text" class="form-input" id="name-input" placeholder="è¯·è¾“å…¥å§“å">
                <div class="form-error" id="name-error">è¯·è¾“å…¥å§“å</div>
            </div>
            <div class="form-group">
                <label class="form-label">æ€§åˆ«</label>
                <select class="form-input" id="gender-select">
                    <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                    <option value="male">ç”·</option>
                    <option value="female">å¥³</option>
                </select>
                <div class="form-error" id="gender-error">è¯·é€‰æ‹©æ€§åˆ«</div>
            </div>
            <div class="form-group">
                <label class="form-label">å¹´é¾„</label>
                <input type="number" class="form-input" id="age-input" placeholder="è¯·è¾“å…¥å¹´é¾„">
                <div class="form-error" id="age-error">è¯·è¾“å…¥1-120ä¹‹é—´çš„å¹´é¾„</div>
            </div>
            <div class="form-group">
                <label class="form-label">æ‰€åœ¨åŸå¸‚</label>
                <select class="form-input" id="city-select">
                    <option value="">è¯·é€‰æ‹©æ‰€åœ¨åŸå¸‚</option>
                    <option value="åŒ—äº¬">åŒ—äº¬</option>
                    <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                    <option value="å¹¿å·">å¹¿å·</option>
                    <option value="æ·±åœ³">æ·±åœ³</option>
                    <option value="æˆéƒ½">æˆéƒ½</option>
                    <option value="æ­å·">æ­å·</option>
                    <option value="æ­¦æ±‰">æ­¦æ±‰</option>
                    <option value="è¥¿å®‰">è¥¿å®‰</option>
                    <option value="å—äº¬">å—äº¬</option>
                    <option value="é•¿æ²™">é•¿æ²™</option>
                    <option value="é‡åº†">é‡åº†</option>
                    <option value="é’å²›">é’å²›</option>
                    <option value="æ²ˆé˜³">æ²ˆé˜³</option>
                    <option value="å¤§è¿">å¤§è¿</option>
                    <option value="å¦é—¨">å¦é—¨</option>
                    <option value="è‹å·">è‹å·</option>
                    <option value="å¤©æ´¥">å¤©æ´¥</option>
                    <option value="é•¿æ˜¥">é•¿æ˜¥</option>
                    <option value="æµå—">æµå—</option>
                </select>
                <div class="form-error" id="city-error">è¯·é€‰æ‹©æ‰€åœ¨åŸå¸‚</div>
            </div>
            <div class="form-group">
                <label class="form-label">æ‰‹æœºå·</label>
                <input type="tel" class="form-input" id="phone-input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                <div class="form-error" id="phone-error">è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·</div>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()" style="display: none;">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" onclick="validateAndNextStep(1)">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- æ­¥éª¤2ï¼šé¢œè‰²é€‰æ‹© -->
        <div class="page" id="step2-page">
            <div class="page-title">ç¬¬äºŒæ­¥ï¼šé€‰æ‹©é¢œè‰²åå¥½</div>
            <div class="page-subtitle">å·¦é”®é€‰æ‹©æ‚¨å–œæ¬¢çš„é¢œè‰²ï¼ˆæœ€å¤š10ç§ï¼‰ï¼Œå³é”®é€‰æ‹©æ‚¨è®¨åŒçš„é¢œè‰²ï¼ˆæœ€å¤š5ç§ï¼‰</div>
            
            <!-- é¢œè‰²é€‰æ‹©åŒºåŸŸ -->
            <div class="color-selection-area">
                <div class="color-selection-mode">
                    <button class="mode-btn like-mode active" id="likeMode">
                        <span class="mode-icon">ğŸ‘</span>
                        <span class="mode-text">é€‰æ‹©å–œæ¬¢çš„é¢œè‰²</span>
                    </button>
                    <button class="mode-btn dislike-mode" id="dislikeMode">
                        <span class="mode-icon">ğŸ‘</span>
                        <span class="mode-text">é€‰æ‹©è®¨åŒçš„é¢œè‰²</span>
                    </button>
                </div>
                <div class="color-grid">
                    {{range $i, $v := .color_map}}
                    <div class="color-item" style="background: {{$v.RGB}};" data-category="çº¢è‰²ç³»" data-name="{{$v.Name}}"></div>
                    {{end}}
                </div>
            </div>

            <!-- å·²é€‰é¢œè‰²å±•ç¤º -->
            <div class="selected-colors">
                <div class="selected-colors-title">å–œæ¬¢çš„é¢œè‰² <span id="liked-count">0</span>/10</div>
                <div class="selected-colors-list" id="liked-colors-list">
                    <!-- å·²é€‰é¢œè‰²ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>

            <!-- ä¸å–œæ¬¢çš„é¢œè‰²å±•ç¤º -->
            <div class="selected-colors" style="margin-top: 16px;">
                <div class="selected-colors-title">è®¨åŒçš„é¢œè‰² <span id="disliked-count">0</span>/5</div>
                <div class="selected-colors-list" id="disliked-colors-list">
                    <!-- ä¸å–œæ¬¢çš„é¢œè‰²ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" onclick="nextStep(2)">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- æ­¥éª¤3ï¼šå½¢å®¹è¯é€‰æ‹© -->
        <div class="page" id="step3-page">
            <div class="page-title">ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©é£æ ¼åå¥½</div>
            <div class="page-subtitle">è¯·é€‰æ‹©æ‚¨å–œæ¬¢çš„å½¢å®¹è¯ï¼ˆæœ€å¤š10ä¸ªï¼‰</div>
            <div class="adjective-list">
                {{range $i, $v := .word_map}}
                <div class="adjective-item" data-name="{{$v}}">{{$v}}</div>
                {{end}}
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" onclick="nextStep(3)">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- æ­¥éª¤4ï¼šå›¾ç‰‡é€‰æ‹© -->
        <div class="page" id="step4-page">
            <div class="page-title">ç¬¬å››æ­¥ï¼šé€‰æ‹©å›¾ç‰‡åå¥½</div>
            <div class="page-subtitle">è¯·ä»æ¯ä¸ªç±»åˆ«ä¸­é€‰æ‹©ä¸€å¼ æœ€å–œæ¬¢çš„å›¾ç‰‡</div>
            
            <!-- å›¾ç‰‡ç±»åˆ«é€‰æ‹© -->
            <div class="image-categories">
                <div class="category-tab active" data-category="clothing">æœè£…</div>
                <div class="category-tab" data-category="car">æ±½è½¦</div>
                <div class="category-tab" data-category="living">åº§æ¤…</div>
                <div class="category-tab" data-category="life">ç”Ÿæ´»æ–¹å¼</div>
                <div class="category-tab" data-category="keting">å®¢å…</div>
                <div class="category-tab" data-category="canting">é¤å…</div>
                <div class="category-tab" data-category="woshi">å§å®¤</div>
                <div class="category-tab" data-category="weishengjian">å«ç”Ÿé—´</div>
                <div class="category-tab" data-category="chufang">å¨æˆ¿</div>
                <div class="category-tab" data-category="xiyifang">æ´—è¡£æˆ¿</div>
            </div>

            <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
            <div class="image-selection-area">
                <div class="image-grid">
                    <!-- å›¾ç‰‡é¡¹ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>

            <!-- å·²é€‰å›¾ç‰‡å±•ç¤º -->
            <div class="selected-images-summary">
                <div class="selected-images-title">å·²é€‰æ‹©</div>
                <div class="selected-images-list">
                    <!-- å·²é€‰å›¾ç‰‡ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" onclick="generateReport()">ç”ŸæˆæŠ¥å‘Š</button>
            </div>
        </div>

        <!-- æŠ¥å‘Šé¡µé¢ -->
        <div class="page" id="report-page">         
            <div class="report-section">
                <div class="report-header">
                    <div class="user-info">
                        <div class="user-name">å¼ å…ˆç”Ÿ</div>
                        <div class="user-meta">28å² Â· åŒ—äº¬</div>
                    </div>
                    <div class="report-date">2024-03-21</div>
                </div>

                <div class="report-card">
                    <div class="report-card-title">
                        <i class="fas fa-palette"></i>
                        è‰²å½©åå¥½
                    </div>
                    <div class="report-card-content">
                        <div class="color-analysis">
                            <div class="analysis-section">
                                <div class="section-title">å–œæ¬¢çš„é¢œè‰²</div>
                                <div class="color-list">
                                    <div class="color-tag" style="background: #FF3B30;">çº¢è‰²</div>
                                    <div class="color-tag" style="background: #FF9500;">æ©™è‰²</div>
                                    <div class="color-tag" style="background: #FFCC00;">é»„è‰²</div>
                                </div>
                            </div>
                            <div class="analysis-section">
                                <div class="section-title">è®¨åŒçš„é¢œè‰²</div>
                                <div class="color-list">
                                    <div class="color-tag" style="background: #4CD964;">ç»¿è‰²</div>
                                    <div class="color-tag" style="background: #5AC8FA;">è“è‰²</div>
                                </div>
                            </div>
                        </div>
                        <div class="analysis-text">

                        </div>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-card-title">
                        <i class="fas fa-paint-brush"></i>
                        å½¢å®¹è¯åå¥½
                    </div>
                    <div class="report-card-content">
                        <div class="style-analysis">
                            <div class="selected-adjectives">
                                <div class="adjective-tag">ç®€çº¦</div>
                                <div class="adjective-tag">ç°ä»£</div>
                                <div class="adjective-tag">ç§‘æŠ€</div>
                            </div>
                        </div>
                        <div class="analysis-text">

                        </div>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-card-title">
                        <i class="fas fa-images"></i>
                        è‰²å½©åˆ†æ
                    </div>
                    <div class="report-card-content">
                        <div class="visual-analysis">
                            <div class="selected-images">
                                
                            </div>
                        </div>
                        <div class="analysis-text">

                        </div>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-card-title">
                        <i class="fas fa-lightbulb"></i>
                        åæ ‡åˆ†æ
                    </div>
                    <div class="report-card-content">
                        <div class="summary-analysis">
                            <div class="summary-points">
                                <div class="point">
                                    <i class="fas fa-check-circle"></i>
                                    
                                </div>
                                <div class="point">
                                    <i class="fas fa-check-circle"></i>
                                    
                                </div>
                                <div class="point">
                                    <i class="fas fa-check-circle"></i>
                                    
                                </div>
                            </div>
                        </div>
                        <div class="analysis-text">

                        </div>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-card-title">
                        <i class="fas fa-images"></i>
                        è¯„ä»·æ€»ç»“
                    </div>
                    <div class="report-card-content">
                        <div class="analysis-text" id="ana-comment">

                        </div>
                    </div>
                </div>

                <div class="report-actions">
                    <button id="continue-test-btn" class="btn btn-secondary">ç»§ç»­æµ‹è¯•</button>
                    <button id="share-report-btn" class="btn btn-primary">åˆ†äº«æŠ¥å‘Š</button>
                </div>
            </div>
        </div>

        <!-- æˆ‘çš„é¡µé¢ -->
        <div class="page" id="profile-page">
            <div class="page-title">æˆ‘çš„</div>
            <div class="form-group">
                <div style="text-align: center; padding: 32px 0;">
                    <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=800&auto=format&fit=crop" alt="å¤´åƒ" style="width: 80px; height: 80px; border-radius: 40px; object-fit: cover;">
                    <div style="margin-top: 8px; font-size: 18px; font-weight: 500;">ç”¨æˆ·å</div>
                    <div style="color: #999; font-size: 14px;">138****8888</div>
                </div>
            </div>
            <div class="form-group">
                <div class="form-label">å†å²è®°å½•</div>
                <div style="background: #f7f7f7; border-radius: 4px; padding: 12px;">
                    <div style="padding: 12px 0; border-bottom: 1px solid #eee;">
                        <div style="font-weight: 500;">2024-03-20</div>
                        <div style="color: #999; font-size: 14px;">å®¡ç¾åå¥½æŠ¥å‘Š</div>
                    </div>
                    <div style="padding: 12px 0;">
                        <div style="font-weight: 500;">2024-03-19</div>
                        <div style="color: #999; font-size: 14px;">å®¡ç¾åå¥½æŠ¥å‘Š</div>
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary">é€€å‡ºç™»å½•</button>
        </div>

    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 4;

        // æ›´æ–°å¯¼èˆªæ 
        function updateNavigation() {
            const backBtn = document.getElementById('back-btn');
            const prevBtn = document.getElementById('prev-btn');
            const pageTitle = document.getElementById('page-title');
            
            if (document.getElementById('report-page').classList.contains('active')) {
                backBtn.style.display = 'block';
                prevBtn.style.display = 'none';
                pageTitle.textContent = 'å®¡ç¾æŠ¥å‘Š';
            } else if (currentStep === 1) {
                backBtn.style.display = 'none';
                prevBtn.style.display = 'none';
                pageTitle.textContent = 'å®¡ç¾æµ‹è¯•';
                // éšè—ç¬¬ä¸€æ­¥çš„ä¸Šä¸€æ­¥æŒ‰é’®
                document.querySelector('#step1-page .btn-secondary').style.display = 'none';
            } else {
                backBtn.style.display = 'none';
                prevBtn.style.display = 'none';
                pageTitle.textContent = 'å®¡ç¾æµ‹è¯•';
                // æ˜¾ç¤ºå½“å‰æ­¥éª¤çš„ä¸Šä¸€æ­¥æŒ‰é’®
                document.querySelector(`#step${currentStep}-page .btn-secondary`).style.display = 'block';
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const progress = document.getElementById('progress');
            progress.style.width = `${(currentStep / totalSteps) * 100}%`;
        }

        // ä¸‹ä¸€æ­¥
        function nextStep(step) {
            if (step < totalSteps) {
                document.getElementById(`step${step}-page`).classList.remove('active');
                document.getElementById(`step${step + 1}-page`).classList.add('active');
                currentStep = step + 1;
                updateProgress();
                updateNavigation();
                
                // å¦‚æœè¿›å…¥é¢œè‰²é€‰æ‹©é¡µé¢ï¼Œé‡æ–°éšæœºåˆ†å¸ƒé¢œè‰²
                if (currentStep === 2) {
                    setTimeout(randomizeVisibleColors, 50);
                }
            } else {
                // ç”ŸæˆæŠ¥å‘Š
                document.getElementById(`step${step}-page`).classList.remove('active');
                document.getElementById('report-page').classList.add('active');
                updateNavigation();
            }
        }

        // ä¸Šä¸€æ­¥
        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}-page`).classList.remove('active');
                document.getElementById(`step${currentStep - 1}-page`).classList.add('active');
                currentStep--;
                updateProgress();
                updateNavigation();
                
                // å¦‚æœå›åˆ°äº†é¢œè‰²é€‰æ‹©é¡µé¢ï¼Œé‡æ–°éšæœºåˆ†å¸ƒé¢œè‰²
                if (currentStep === 2) {
                    setTimeout(randomizeVisibleColors, 50);
                }
            }
        }

        // è¿”å›æŒ‰é’®
        document.getElementById('back-btn').addEventListener('click', () => {
            if (document.getElementById('report-page').classList.contains('active')) {
                document.getElementById('report-page').classList.remove('active');
                document.getElementById('step4-page').classList.add('active');
                currentStep = 4;
                updateProgress();
                updateNavigation();
            }
        });

        // ä¸Šä¸€æ­¥æŒ‰é’®
        document.getElementById('prev-btn').addEventListener('click', prevStep);

        // é¡µé¢åˆ‡æ¢é€»è¾‘
        const tabItems = document.querySelectorAll('.tab-item');
        const pages = document.querySelectorAll('.page');

        tabItems.forEach((tab, index) => {
            tab.addEventListener('click', () => {
                // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                tabItems.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                pages.forEach(p => p.classList.remove('active'));
                if (index === 0) {
                    document.getElementById('step1-page').classList.add('active');
                    currentStep = 1;
                    updateProgress();
                    updateNavigation();
                } else {
                    document.getElementById('profile-page').classList.add('active');
                    document.getElementById('page-title').textContent = 'æˆ‘çš„';
                }
            });
        });

        // é¢œè‰²é€‰æ‹©ç›¸å…³é€»è¾‘
        let likedColors = new Set();
        let dislikedColors = new Set();

        // è·å–é¢œè‰²åç§°
        function getColorName(color) {
            // å°è¯•è·å–é¢œè‰²åç§°
            for (let item of document.querySelectorAll('.color-item')) {
                let itemStyle = item.getAttribute('style') || '';
                let styleColor = itemStyle.match(/background:\s*([^;]+)/);
                
                if (styleColor && styleColor[1]) {
                    // ä½¿ç”¨styleå±æ€§ä¸­çš„é¢œè‰²å€¼æ¯”è¾ƒ
                    if (color.includes(styleColor[1]) || styleColor[1].includes(color)) {
                        return item.dataset.name || 'æœªçŸ¥é¢œè‰²';
                    }
                }
                
                // åå¤‡æ–¹æ¡ˆï¼šä½¿ç”¨è®¡ç®—åçš„æ ·å¼
                let itemColor = getComputedStyle(item).backgroundColor;
                if (itemColor === color) {
                    return item.dataset.name || 'æœªçŸ¥é¢œè‰²';
                }
            }
            return 'æœªçŸ¥é¢œè‰²';
        }

        // é¢œè‰²é€‰æ‹©
        function initColorSelection() {
            // åˆå§‹åŒ–é¢œè‰²é¡¹ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.color-item').forEach(item => {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé˜²æ­¢é‡å¤ç»‘å®šï¼‰
                item.removeEventListener('click', handleColorClick);
                item.removeEventListener('contextmenu', handleColorRightClick);
                
                // ç‚¹å‡»é€‰æ‹©é¢œè‰²ï¼ˆæ ¹æ®å½“å‰æ¨¡å¼ï¼‰
                item.addEventListener('click', handleColorClick);
                
                // å³é”®ç‚¹å‡»ä»ç„¶é˜»æ­¢é»˜è®¤èœå•
                item.addEventListener('contextmenu', handleColorRightClick);
            });
            
            // åˆå§‹åŒ–æ¨¡å¼åˆ‡æ¢æŒ‰é’®
            const likeModeBtn = document.getElementById('likeMode');
            const dislikeModeBtn = document.getElementById('dislikeMode');
            
            likeModeBtn.addEventListener('click', () => {
                setColorSelectionMode('like');
            });
            
            dislikeModeBtn.addEventListener('click', () => {
                setColorSelectionMode('dislike');
            });
        }
        
        // å½“å‰é€‰æ‹©æ¨¡å¼ï¼š'like' æˆ– 'dislike'
        let currentSelectionMode = 'like';
        
        // è®¾ç½®é¢œè‰²é€‰æ‹©æ¨¡å¼
        function setColorSelectionMode(mode) {
            currentSelectionMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const likeModeBtn = document.getElementById('likeMode');
            const dislikeModeBtn = document.getElementById('dislikeMode');
            
            if (mode === 'like') {
                likeModeBtn.classList.add('active');
                dislikeModeBtn.classList.remove('active');
            } else {
                likeModeBtn.classList.remove('active');
                dislikeModeBtn.classList.add('active');
            }
        }
        
        // å¤„ç†é¢œè‰²ç‚¹å‡»
        function handleColorClick(e) {
            const item = e.currentTarget;
            const originalBackground = item.style.background || '';
            let color = originalBackground;
            
            // å¦‚æœæ²¡æœ‰ç›´æ¥è·å–åˆ°èƒŒæ™¯è‰²ï¼Œä½¿ç”¨è®¡ç®—æ ·å¼
            if (!color) {
                color = getComputedStyle(item).backgroundColor;
            }
            
            // æ ¹æ®å½“å‰æ¨¡å¼å¤„ç†ç‚¹å‡»
            if (currentSelectionMode === 'like') {
                // å–œæ¬¢æ¨¡å¼
                if (likedColors.has(color)) {
                    likedColors.delete(color);
                    item.classList.remove('selected-like');
                } else if (dislikedColors.has(color)) {
                    alert('è¯¥é¢œè‰²å·²è¢«é€‰ä¸ºè®¨åŒçš„é¢œè‰²');
                } else if (likedColors.size < 10) {
                    // å­˜å‚¨é¢œè‰²å€¼å’Œåç§°
                    likedColors.add(color);
                    item.classList.add('selected-like');
                } else {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©10ç§å–œæ¬¢çš„é¢œè‰²');
                }
            } else {
                // è®¨åŒæ¨¡å¼
                if (dislikedColors.has(color)) {
                    dislikedColors.delete(color);
                    item.classList.remove('selected-dislike');
                } else if (likedColors.has(color)) {
                    alert('è¯¥é¢œè‰²å·²è¢«é€‰ä¸ºå–œæ¬¢çš„é¢œè‰²');
                } else if (dislikedColors.size < 5) {
                    // å­˜å‚¨é¢œè‰²å€¼å’Œåç§°
                    dislikedColors.add(color);
                    item.classList.add('selected-dislike');
                } else {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©5ç§è®¨åŒçš„é¢œè‰²');
                }
            }
            
            updateSelectedColors();
        }

        // å¤„ç†é¢œè‰²å³é”®ç‚¹å‡» - ä¿ç•™æ­¤å‡½æ•°ä»¥å…¼å®¹æ—§ä»£ç ï¼Œä½†ä¸å†ä½¿ç”¨
        function handleColorRightClick(e) {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
        }

        // æ·»åŠ æ˜Ÿæ˜Ÿé—ªçƒæ•ˆæœ
        function addTwinkleEffect() {
            const colorItems = document.querySelectorAll('.color-item');
            
            colorItems.forEach(item => {
                // éšæœºè®¾ç½®é—ªçƒé—´éš”
                const twinkleInterval = 3000 + Math.random() * 7000; // 3-10ç§’
                
                // é—ªçƒåŠ¨ç”» - ç®€å•çš„é€æ˜åº¦å˜åŒ–
                setInterval(() => {
                    item.style.opacity = '0.7';
                    setTimeout(() => {
                        item.style.opacity = '1';
                    }, 300);
                }, twinkleInterval);
            });
        }

        // é¢œè‰²åˆ†ç±»åˆ‡æ¢
        document.querySelectorAll('.category-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                document.querySelectorAll('.category-tag').forEach(t => t.classList.remove('active'));
                tag.classList.add('active');
                filterColors(tag.textContent);
                // åº”ç”¨éšæœºåˆ†å¸ƒäºå¯è§é¢œè‰²
                setTimeout(randomizeVisibleColors, 50);
            });
        });


        // ä»¥æ˜Ÿç©ºé£æ ¼éšæœºåˆ†å¸ƒæ‰€æœ‰é¢œè‰²é¡¹
        function randomizeColorItems() {
            const container = document.querySelector('.color-grid');
            const colorItems = document.querySelectorAll('.color-item');
            const containerWidth = container.offsetWidth || 300; // æä¾›é»˜è®¤å®½åº¦
            
            // åˆå§‹åŒ–è‡ªé€‚åº”é«˜åº¦
            container.style.height = 'auto';
            
            // åˆ›å»ºæ˜Ÿç©ºåˆ†å¸ƒ
            const totalItems = colorItems.length;
            const cellSize = 46; // å¢åŠ 15%çš„è·ç¦»
            const rows = Math.ceil(Math.sqrt(totalItems * 2)); // åˆ›å»ºæ›´å®½æ¾çš„åˆ†å¸ƒ
            let containerHeight = rows * cellSize * 1.5;
            
            // ç”¨äºæ£€æµ‹ç¢°æ’çš„å‡½æ•°
            function isOverlapping(x, y, radius, positions) {
                for (let pos of positions) {
                    const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
                    if (distance < (radius + pos.radius + 5)) { // å¢åŠ 5pxé—´è·
                        return true;
                    }
                }
                return false;
            }
            
            // ç”Ÿæˆæ˜Ÿæ˜Ÿä½ç½®
            const positions = [];
            const minRadius = 18;
            const maxRadius = 22;
            
            // åˆ†åŒºåŸŸå¸ƒå±€å¢åŠ æ˜Ÿå›¢æ•ˆæœ
            const numClusters = 5;
            const clusterCenters = [];
            
            // åˆ›å»ºæ˜Ÿå›¢ä¸­å¿ƒç‚¹
            for (let i = 0; i < numClusters; i++) {
                clusterCenters.push({
                    x: Math.random() * containerWidth,
                    y: Math.random() * containerHeight,
                    strength: 0.5 + Math.random() * 0.5 // æ˜Ÿå›¢å¼•åŠ›å¼ºåº¦
                });
            }
            
            // ä¸ºæ¯ä¸ªé¢œè‰²é¡¹åˆ†é…ä½ç½®
            colorItems.forEach((item, index) => {
                // éšæœºå¤§å°å˜åŒ–
                const sizeVariation = 0.85 + Math.random() * 0.3; // 0.85-1.15å€å¤§å°
                const radius = Math.round(minRadius + Math.random() * (maxRadius - minRadius));
                const size = Math.round(radius * 2 * sizeVariation);
                
                // å°è¯•æ‰¾åˆ°ä¸é‡å çš„ä½ç½®
                let x, y;
                let maxAttempts = 100;
                let attempts = 0;
                let validPosition = false;
                
                while (!validPosition && attempts < maxAttempts) {
                    attempts++;
                    
                    // éšæœºé€‰æ‹©æ˜¯åœ¨æ˜Ÿå›¢é™„è¿‘è¿˜æ˜¯åœ¨éšæœºä½ç½®
                    const useCluster = Math.random() < 0.7; // 70%æ¦‚ç‡ä½¿ç”¨æ˜Ÿå›¢
                    
                    if (useCluster) {
                        // é€‰æ‹©ä¸€ä¸ªæ˜Ÿå›¢
                        const cluster = clusterCenters[Math.floor(Math.random() * numClusters)];
                        // åœ¨æ˜Ÿå›¢é™„è¿‘ç”Ÿæˆä½ç½®ï¼Œè·ç¦»è¶Šè¿œæ¦‚ç‡è¶Šå°
                        const angle = Math.random() * Math.PI * 2;
                        const distance = Math.random() * Math.random() * containerWidth * 0.4 * cluster.strength;
                        x = cluster.x + Math.cos(angle) * distance;
                        y = cluster.y + Math.sin(angle) * distance;
                    } else {
                        // å®Œå…¨éšæœºä½ç½®
                        x = Math.random() * (containerWidth - size);
                        y = Math.random() * containerHeight;
                    }
                    
                    // ç¡®ä¿åœ¨å®¹å™¨å†…
                    x = Math.max(radius, Math.min(containerWidth - radius, x));
                    y = Math.max(radius, Math.min(containerHeight - radius, y));
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–é¡¹é‡å 
                    validPosition = !isOverlapping(x, y, radius, positions);
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°ä¸é‡å çš„ä½ç½®ï¼Œå°±å¢åŠ é«˜åº¦å†è¯•
                if (!validPosition) {
                    y = containerHeight + radius + Math.random() * 50;
                    x = Math.random() * (containerWidth - size);
                    containerHeight = y + radius + 20;
                }
                
                // ä¿å­˜ä½ç½®
                positions.push({ x, y, radius });
                
                // è®¾ç½®é¡¹çš„å¤§å°
                item.style.width = `${size}px`;
                item.style.height = `${size}px`;
                
                // æ·»åŠ æ›´å¤§çš„éšæœºæ—‹è½¬æ•ˆæœï¼Œ20-40åº¦
                const randomRotate = 20 + Math.random() * 20; // 20-40åº¦æ—‹è½¬
                const randomDirection = Math.random() > 0.5 ? 1 : -1;
                
                // è®¾ç½®ä½ç½®
                item.style.left = (x - radius) + 'px';
                item.style.top = (y - radius) + 'px';
                item.style.transform = `rotate(${randomRotate * randomDirection}deg)`;
            });
            
            // è®¾ç½®å®¹å™¨é«˜åº¦
            container.style.height = (containerHeight + 20) + 'px';
        }

        // ä»¥æ˜Ÿç©ºé£æ ¼éšæœºåˆ†å¸ƒå¯è§çš„é¢œè‰²é¡¹
        function randomizeVisibleColors() {
            const container = document.querySelector('.color-grid');
            const colorItems = document.querySelectorAll('.color-item:not([style*="display: none"])');
            const containerWidth = container.offsetWidth || 300; // æä¾›é»˜è®¤å®½åº¦
            
            // åˆå§‹åŒ–è‡ªé€‚åº”é«˜åº¦
            container.style.height = 'auto';
            
            // åˆ›å»ºæ˜Ÿç©ºåˆ†å¸ƒ
            const totalItems = colorItems.length;
            const cellSize = 46; // å¢åŠ 15%çš„è·ç¦»
            const rows = Math.ceil(Math.sqrt(totalItems * 2)); // åˆ›å»ºæ›´å®½æ¾çš„åˆ†å¸ƒ
            let containerHeight = rows * cellSize * 1.5;
            
            // ç”¨äºæ£€æµ‹ç¢°æ’çš„å‡½æ•°
            function isOverlapping(x, y, radius, positions) {
                for (let pos of positions) {
                    const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
                    if (distance < (radius + pos.radius + 5)) { // å¢åŠ 5pxé—´è·
                        return true;
                    }
                }
                return false;
            }
            
            // ç”Ÿæˆæ˜Ÿæ˜Ÿä½ç½®
            const positions = [];
            const minRadius = 18;
            const maxRadius = 22;
            
            // åˆ†åŒºåŸŸå¸ƒå±€å¢åŠ æ˜Ÿå›¢æ•ˆæœ
            const numClusters = 5;
            const clusterCenters = [];
            
            // åˆ›å»ºæ˜Ÿå›¢ä¸­å¿ƒç‚¹
            for (let i = 0; i < numClusters; i++) {
                clusterCenters.push({
                    x: Math.random() * containerWidth,
                    y: Math.random() * containerHeight,
                    strength: 0.5 + Math.random() * 0.5 // æ˜Ÿå›¢å¼•åŠ›å¼ºåº¦
                });
            }
            
            // ä¸ºæ¯ä¸ªé¢œè‰²é¡¹åˆ†é…ä½ç½®
            colorItems.forEach((item, index) => {
                // éšæœºå¤§å°å˜åŒ–
                const sizeVariation = 0.85 + Math.random() * 0.3; // 0.85-1.15å€å¤§å°
                const radius = Math.round(minRadius + Math.random() * (maxRadius - minRadius));
                const size = Math.round(radius * 2 * sizeVariation);
                
                // å°è¯•æ‰¾åˆ°ä¸é‡å çš„ä½ç½®
                let x, y;
                let maxAttempts = 100;
                let attempts = 0;
                let validPosition = false;
                
                while (!validPosition && attempts < maxAttempts) {
                    attempts++;
                    
                    // éšæœºé€‰æ‹©æ˜¯åœ¨æ˜Ÿå›¢é™„è¿‘è¿˜æ˜¯åœ¨éšæœºä½ç½®
                    const useCluster = Math.random() < 0.7; // 70%æ¦‚ç‡ä½¿ç”¨æ˜Ÿå›¢
                    
                    if (useCluster) {
                        // é€‰æ‹©ä¸€ä¸ªæ˜Ÿå›¢
                        const cluster = clusterCenters[Math.floor(Math.random() * numClusters)];
                        // åœ¨æ˜Ÿå›¢é™„è¿‘ç”Ÿæˆä½ç½®ï¼Œè·ç¦»è¶Šè¿œæ¦‚ç‡è¶Šå°
                        const angle = Math.random() * Math.PI * 2;
                        const distance = Math.random() * Math.random() * containerWidth * 0.4 * cluster.strength;
                        x = cluster.x + Math.cos(angle) * distance;
                        y = cluster.y + Math.sin(angle) * distance;
                    } else {
                        // å®Œå…¨éšæœºä½ç½®
                        x = Math.random() * (containerWidth - size);
                        y = Math.random() * containerHeight;
                    }
                    
                    // ç¡®ä¿åœ¨å®¹å™¨å†…
                    x = Math.max(radius, Math.min(containerWidth - radius, x));
                    y = Math.max(radius, Math.min(containerHeight - radius, y));
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–é¡¹é‡å 
                    validPosition = !isOverlapping(x, y, radius, positions);
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°ä¸é‡å çš„ä½ç½®ï¼Œå°±å¢åŠ é«˜åº¦å†è¯•
                if (!validPosition) {
                    y = containerHeight + radius + Math.random() * 50;
                    x = Math.random() * (containerWidth - size);
                    containerHeight = y + radius + 20;
                }
                
                // ä¿å­˜ä½ç½®
                positions.push({ x, y, radius });
                
                // è®¾ç½®é¡¹çš„å¤§å°
                item.style.width = `${size}px`;
                item.style.height = `${size}px`;
                
                // æ·»åŠ æ›´å¤§çš„éšæœºæ—‹è½¬æ•ˆæœï¼Œ20-40åº¦
                const randomRotate = 20 + Math.random() * 20; // 20-40åº¦æ—‹è½¬
                const randomDirection = Math.random() > 0.5 ? 1 : -1;
                
                // è®¾ç½®ä½ç½®
                item.style.left = (x - radius) + 'px';
                item.style.top = (y - radius) + 'px';
                item.style.transform = `rotate(${randomRotate * randomDirection}deg)`;
            });
            
            // è®¾ç½®å®¹å™¨é«˜åº¦
            container.style.height = (containerHeight + 20) + 'px';
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            try {
                // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ‰§è¡Œå¤æ‚æ“ä½œï¼Œé¿å…é˜»å¡é¡µé¢åŠ è½½
                setTimeout(() => {
                    randomizeColorItems();
                    initColorSelection();
                    initImageSelection();
                }, 100);
            } catch (error) {
                console.error('åˆå§‹åŒ–å‡ºé”™:', error);
                // å³ä½¿å‡ºé”™ä¹Ÿç¡®ä¿UIå¯ç”¨
                initColorSelection();
                initImageSelection();
            }
        });

        // è¡¨å•éªŒè¯å‡½æ•°
        function validateForm() {
            let isValid = true;
            const nameInput = document.getElementById('name-input');
            const genderSelect = document.getElementById('gender-select');
            const ageInput = document.getElementById('age-input');
            const citySelect = document.getElementById('city-select');
            const phoneInput = document.getElementById('phone-input');

            // å§“åéªŒè¯
            if (!nameInput.value.trim()) {
                showError(nameInput, 'name-error', 'è¯·è¾“å…¥å§“å');
                isValid = false;
            } else {
                hideError(nameInput, 'name-error');
            }

            // æ€§åˆ«éªŒè¯
            if (!genderSelect.value) {
                showError(genderSelect, 'gender-error', 'è¯·é€‰æ‹©æ€§åˆ«');
                isValid = false;
            } else {
                hideError(genderSelect, 'gender-error');
            }

            // å¹´é¾„éªŒè¯
            const age = parseInt(ageInput.value);
            if (!ageInput.value || isNaN(age) || age < 1 || age > 120) {
                showError(ageInput, 'age-error', 'è¯·è¾“å…¥1-120ä¹‹é—´çš„å¹´é¾„');
                isValid = false;
            } else {
                hideError(ageInput, 'age-error');
            }

            // åŸå¸‚éªŒè¯
            if (!citySelect.value) {
                showError(citySelect, 'city-error', 'è¯·é€‰æ‹©æ‰€åœ¨åŸå¸‚');
                isValid = false;
            } else {
                hideError(citySelect, 'city-error');
            }

            // æ‰‹æœºå·éªŒè¯
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneInput.value.trim()) {
                showError(phoneInput, 'phone-error', 'è¯·è¾“å…¥æ‰‹æœºå·');
                isValid = false;
            } else if (!phoneRegex.test(phoneInput.value)) {
                showError(phoneInput, 'phone-error', 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
                isValid = false;
            } else {
                hideError(phoneInput, 'phone-error');
            }

            return isValid;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(input, errorId, message) {
            input.classList.add('error');
            const errorElement = document.getElementById(errorId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError(input, errorId) {
            input.classList.remove('error');
            document.getElementById(errorId).style.display = 'none';
        }

        // éªŒè¯å¹¶è¿›å…¥ä¸‹ä¸€æ­¥
        function validateAndNextStep(step) {
            if (step === 1 && !validateForm()) {
                return;
            }
            nextStep(step);
        }

        // æ·»åŠ è¾“å…¥æ¡†å®æ—¶éªŒè¯
        document.getElementById('name-input').addEventListener('input', function() {
            if (this.value.trim()) {
                hideError(this, 'name-error');
            }
        });

        document.getElementById('gender-select').addEventListener('change', function() {
            if (this.value) {
                hideError(this, 'gender-error');
            }
        });

        document.getElementById('age-input').addEventListener('input', function() {
            const age = parseInt(this.value);
            if (this.value && !isNaN(age) && age >= 1 && age <= 120) {
                hideError(this, 'age-error');
            }
        });

        document.getElementById('city-select').addEventListener('change', function() {
            if (this.value) {
                hideError(this, 'city-error');
            }
        });

        document.getElementById('phone-input').addEventListener('input', function() {
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (this.value.trim() && phoneRegex.test(this.value)) {
                hideError(this, 'phone-error');
            }
        });

        // æ›´æ–°å·²é€‰é¢œè‰²å±•ç¤º
        function updateSelectedColors() {
            const likedContainer = document.getElementById('liked-colors-list');
            const dislikedContainer = document.getElementById('disliked-colors-list');
            const likedCount = document.getElementById('liked-count');
            const dislikedCount = document.getElementById('disliked-count');
            
            // æ›´æ–°å–œæ¬¢çš„é¢œè‰²
            likedContainer.innerHTML = '';
            likedCount.textContent = likedColors.size;
            
            likedColors.forEach(color => {
                const colorName = getColorName(color);
                const item = document.createElement('div');
                item.className = 'selected-color-item';
                item.innerHTML = `
                    <div class="selected-color-preview" style="background: ${color}"></div>
                    <span>${colorName}</span>
                    <i class="fas fa-times remove-color"></i>
                `;
                
                item.querySelector('.remove-color').addEventListener('click', () => {
                    likedColors.delete(color);
                    const colorItem = document.querySelector(`.color-item[style*="${color}"]`);
                    if (colorItem) {
                        colorItem.classList.remove('selected-like');
                    }
                    updateSelectedColors();
                });
                
                likedContainer.appendChild(item);
            });

            // æ›´æ–°ä¸å–œæ¬¢çš„é¢œè‰²
            dislikedContainer.innerHTML = '';
            dislikedCount.textContent = dislikedColors.size;
            
            dislikedColors.forEach(color => {
                const colorName = getColorName(color);
                const item = document.createElement('div');
                item.className = 'selected-color-item';
                item.innerHTML = `
                    <div class="selected-color-preview" style="background: ${color}"></div>
                    <span>${colorName}</span>
                    <i class="fas fa-times remove-color"></i>
                `;
                
                item.querySelector('.remove-color').addEventListener('click', () => {
                    dislikedColors.delete(color);
                    const colorItem = document.querySelector(`.color-item[style*="${color}"]`);
                    if (colorItem) {
                        colorItem.classList.remove('selected-dislike');
                    }
                    updateSelectedColors();
                });
                
                dislikedContainer.appendChild(item);
            });
        }

        // ç”ŸæˆæŠ¥å‘Š
        function generateReport() {
            // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
            showToast('æ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œè¯·ç¨å€™...');
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å°ç¨‹åºç¯å¢ƒä¸­
            if (window.__wxjs_environment === 'miniprogram' && window.wx && window.wx.miniProgram) {
                console.info('åœ¨å°ç¨‹åºç¯å¢ƒä¸­ç”ŸæˆæŠ¥å‘Š');
                generateReportWithData('user_token_1747535367_1747535367384149000');
                
                // è®¾ç½®tokenå›è°ƒå‡½æ•°
                /*window.tokenCallback = function(token) {
                    console.info('é€šè¿‡å›è°ƒè·å–åˆ°tokenï¼Œç»§ç»­ç”ŸæˆæŠ¥å‘Š');
                    generateReportWithData(token);
                };
                
                // å‘å°ç¨‹åºè¯·æ±‚token
                wx.miniProgram.postMessage({
                    data: {
                        type: 'getToken',
                        message: 'è¯·æ±‚è·å–token'
                    }
                });*/
                console.info('å·²å‘å°ç¨‹åºå‘é€getTokenè¯·æ±‚');
            } else {
                console.info('å½“å‰ç¯å¢ƒéå¾®ä¿¡å°ç¨‹åº');
                // éå¾®ä¿¡å°ç¨‹åºç¯å¢ƒï¼Œä½¿ç”¨æœ¬åœ°tokenæˆ–é»˜è®¤æµç¨‹
                const localToken = localStorage.getItem('aesthetic_token');
                if (localToken) {
                    console.log('ä½¿ç”¨æœ¬åœ°token:', localToken);
                    generateReportWithData(localToken);
                } else {
                    showToast('è¯·å…ˆç™»å½•åå†ç”ŸæˆæŠ¥å‘Š');
                    // å¯ä»¥é€‰æ‹©è·³è½¬åˆ°ç™»å½•é¡µé¢æˆ–ä½¿ç”¨é»˜è®¤æµç¨‹
                    handleLogin().then(() => {
                        const newToken = localStorage.getItem('aesthetic_token');
                        if (newToken) {
                            generateReportWithData(newToken);
                        } else {
                            generateReportWithData();
                        }
                    });
                }
            }
        }
        
        // ä½¿ç”¨æ•°æ®ç”ŸæˆæŠ¥å‘Š
        function generateReportWithData(token) {
            console.info('generateReportWithData-ä½¿ç”¨token:', token);
            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = {
                    name: document.getElementById('name-input').value,
                    gender: document.getElementById('gender-select').value || '',
                    age: parseInt(document.getElementById('age-input').value) || 0,
                    city: document.getElementById('city-select').value,
                    phone: document.getElementById('phone-input').value,
                    liked_colors: Array.from(likedColors.keys()),
                    disliked_colors: Array.from(dislikedColors.keys()),
                    liked_adjectives: Array.from(selectedAdjectives.values()),
                    liked_images: Array.from(selectedImages.keys())
                };
            
            // è¡¨å•éªŒè¯
            //if (!validateFormData(formData)) {
            //   return;
            //}
            // æäº¤æ•°æ®åˆ°æœåŠ¡å™¨
            submitToServer(formData, token);

            document.getElementById('step4-page').classList.remove('active');
            document.getElementById('report-page').classList.add('active');
            document.getElementById('back-btn').style.display = 'block';
            document.getElementById('page-title').textContent = 'å®¡ç¾æŠ¥å‘Š';

            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            const nameInput = document.getElementById('name-input');
            const ageInput = document.getElementById('age-input');
            const citySelect = document.getElementById('city-select');
            const genderSelect = document.getElementById('gender-select');

            const userName = nameInput.value || 'ç”¨æˆ·';
            const userAge = ageInput.value || '25';
            const userCity = citySelect.value || 'æœªçŸ¥åŸå¸‚';
            const userGender = genderSelect.value === 'male' ? 'å…ˆç”Ÿ' : genderSelect.value === 'female' ? 'å¥³å£«' : '';

            document.querySelector('.user-name').textContent = userName + (userGender ? userGender : '');
            document.querySelector('.user-meta').textContent = `${userAge}å² Â· ${userCity}`;

            // æ›´æ–°æŠ¥å‘Šæ—¥æœŸ
            const today = new Date();
            const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            document.querySelector('.report-date').textContent = dateStr;

            // æ›´æ–°æŠ¥å‘Šä¸­çš„é¢œè‰²åˆ†æ
            const colorList = document.querySelector('.color-analysis .color-list');
            const dislikedColorList = document.querySelector('.color-analysis .analysis-section:nth-child(2) .color-list');
            
            // æ¸…ç©ºç°æœ‰çš„é¢œè‰²æ ‡ç­¾
            colorList.innerHTML = '';
            dislikedColorList.innerHTML = '';
            
            // æ·»åŠ å–œæ¬¢çš„é¢œè‰²
            likedColors.forEach(color => {
                const colorName = getColorName(color);
                const colorTag = document.createElement('div');
                colorTag.className = 'color-tag';
                colorTag.style.background = color;
                colorTag.textContent = colorName;
                colorList.appendChild(colorTag);
            });
            
            // æ·»åŠ ä¸å–œæ¬¢çš„é¢œè‰²
            dislikedColors.forEach(color => {
                const colorName = getColorName(color);
                const colorTag = document.createElement('div');
                colorTag.className = 'color-tag';
                colorTag.style.background = color;
                colorTag.textContent = colorName;
                dislikedColorList.appendChild(colorTag);
            });

            // æ›´æ–°æŠ¥å‘Šä¸­çš„å½¢å®¹è¯åˆ†æ
            const adjectiveList = document.querySelector('.style-analysis .selected-adjectives');
            adjectiveList.innerHTML = '';
            
            // æ·»åŠ é€‰ä¸­çš„å½¢å®¹è¯
            selectedAdjectives.forEach(adjective => {
                const adjectiveTag = document.createElement('div');
                adjectiveTag.className = 'adjective-tag';
                adjectiveTag.textContent = adjective;
                adjectiveList.appendChild(adjectiveTag);
            });

            // æ›´æ–°æŠ¥å‘Šä¸­çš„å›¾ç‰‡å±•ç¤º
            const visualAnalysis = document.querySelector('.visual-analysis .selected-images');
            visualAnalysis.innerHTML = '';
            

            // å»¶è¿Ÿåˆå§‹åŒ–3DåŠ¨ç”»ï¼Œç¡®ä¿DOMå·²å®Œå…¨åŠ è½½
            setTimeout(() => {
                initColorAnimation();
            }, 300);
        }

        // éªŒè¯è¡¨å•æ•°æ®
        function validateFormData(data) {
            if (!data.name) {
                alert('è¯·è¾“å…¥å§“å');
                return false;
            }
            
            if (!data.gender) {
                alert('è¯·é€‰æ‹©æ€§åˆ«');
                return false;
            }
            
            if (!data.age || data.age < 1 || data.age > 120) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¹´é¾„(1-120)');
                return false;
            }
            
            if (!data.city) {
                alert('è¯·è¾“å…¥æ‰€åœ¨åŸå¸‚');
                return false;
            }
            
            if (!data.phone) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·ç ');
                return false;
            }
            
            if (!data.liked_colors || data.liked_colors.length < 1) {
                alert('è¯·è‡³å°‘é€‰æ‹©1ä¸ªå–œæ¬¢çš„é¢œè‰²');
                return false;
            }
            
            if (!data.disliked_colors || data.disliked_colors.length < 1) {
                alert('è¯·è‡³å°‘é€‰æ‹©1ä¸ªè®¨åŒçš„é¢œè‰²');
                return false;
            }
            
            if (!data.liked_adjectives || data.liked_adjectives.length < 1) {
                alert('è¯·è‡³å°‘é€‰æ‹©1ä¸ªå–œæ¬¢çš„å½¢å®¹è¯');
                return false;
            }
            
            if (!data.liked_images || data.liked_images.length < 1) {
                alert('è¯·è‡³å°‘é€‰æ‹©1å¼ å–œæ¬¢çš„å›¾ç‰‡');
                return false;
            }
            
            return true;
        }

        // æäº¤æ•°æ®åˆ°æœåŠ¡å™¨
        async function submitToServer(formData, providedToken) {
            // è·å–tokenï¼Œå¦‚æœæ²¡æœ‰åˆ™è¯·æ±‚ç™»å½•
            let token = providedToken || localStorage.getItem('aesthetic_token');
            if (!token) {
                await handleLogin();
                token = localStorage.getItem('aesthetic_token');
                if (!token) return; // å¦‚æœç”¨æˆ·å–æ¶ˆç™»å½•ï¼Œåˆ™ç»ˆæ­¢æäº¤
            }
            
            try {
                const response = await fetch('/api/aesthetic/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                if (result.code === 0) {
                    console.log('æ•°æ®æäº¤æˆåŠŸ');
                    showToast('æŠ¥å‘Šç”ŸæˆæˆåŠŸ');
                    // æ›´æ–°æŠ¥å‘Šä¸­çš„å›¾ç‰‡å±•ç¤º
                    const visualAnalysis = document.querySelector('.visual-analysis');
                    visualAnalysis.innerHTML = '';
                    
                    const imagePreview = document.createElement('div');
                    imagePreview.className = 'image-preview';
                    imagePreview.innerHTML = `
                        <img src="${result.data.color_explor_image}">
                    `;
                    visualAnalysis.appendChild(imagePreview);

                    const summaryPoints = document.querySelector('.summary-points');
                    summaryPoints.innerHTML = '';

                    // æ ¹æ®é¢œè‰²åå¥½ç”Ÿæˆæ€»ç»“ç‚¹
                    const colorPoint = document.createElement('div');
                    colorPoint.className = 'point';
                    colorPoint.innerHTML = `
                        <img src="${result.data.box_explor_image}">
                    `;
                    summaryPoints.appendChild(colorPoint);

                    //comment
                    const commentPoints = document.querySelector('#ana-comment');
                    commentPoints.innerHTML = '';

                    //éå†result.data.comment
                    for (let i = 0; i < result.data.comment.length; i++) {
                        const commentPoint = document.createElement('div');
                        commentPoint.className = 'point';
                        commentPoint.innerHTML = `
                            <i>${result.data.comment[i]}</i>
                        `;
                        commentPoints.appendChild(commentPoint);
                    }
                    
                    // å¦‚æœåœ¨å¾®ä¿¡å°ç¨‹åºä¸­ï¼Œå¯ä»¥ä¿å­˜æŠ¥å‘ŠIDåˆ°å°ç¨‹åºå­˜å‚¨
                    if (window.wx && window.wx.miniProgram && result.data.report_id) {
                        wx.miniProgram.postMessage({
                            data: {
                                type: 'reportGenerated',
                                reportId: result.data.report_id
                            }
                        });
                    }
                } else if (result.code === 401) {
                    // tokenè¿‡æœŸæˆ–æ— æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•
                    localStorage.removeItem('aesthetic_token');
                    showToast('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    await handleLogin();
                    // é‡æ–°å°è¯•æäº¤
                    await submitToServer(formData);
                } else {
                    console.error('æäº¤å¤±è´¥:', result.message);
                    showToast('æäº¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('æäº¤è¯·æ±‚é”™è¯¯:', error);
                showToast('æäº¤æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
            }
        }

        // å¤„ç†ç™»å½•æµç¨‹
        async function handleLogin() {
            // æ£€æŸ¥æ˜¯å¦åœ¨å¾®ä¿¡å°ç¨‹åºç¯å¢ƒä¸­
            if (window.wx && wx.miniProgram) {
                try {
                    // è°ƒç”¨å¾®ä¿¡å°ç¨‹åºçš„è·å–æ‰‹æœºå·æ¥å£
                    wx.miniProgram.navigateTo({
                        url: '/pages/auth/auth?redirect=index',
                        success: function() {
                            console.log('è·³è½¬åˆ°æ‰‹æœºå·æˆæƒé¡µé¢æˆåŠŸ');
                        },
                        fail: function(err) {
                            console.error('è·³è½¬åˆ°æ‰‹æœºå·æˆæƒé¡µé¢å¤±è´¥', err);
                            showToast('è·å–æ‰‹æœºå·æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    });
                    
                    // ç›‘å¬ä»å°ç¨‹åºè¿”å›çš„æ¶ˆæ¯
                    window.addEventListener('message', function(event) {
                        const data = event.data;
                        if (data && data.type === 'getPhoneNumber') {
                            if (data.success) {
                                // è·å–åˆ°æ‰‹æœºå·ï¼Œè¿›è¡Œç™»å½•
                                const phoneNumber = data.phoneNumber;
                                const userInfo = {
                                    name: 'ç”¨æˆ·' + phoneNumber.substring(phoneNumber.length - 4),
                                    phone: phoneNumber,
                                    id: generateUserId()
                                };
                                
                                // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                                localStorage.setItem('userInfo', JSON.stringify(userInfo));
                                
                                // æ›´æ–°UI
                                updateUserInfo(userInfo);
                                
                                // è¿›å…¥ä¸‹ä¸€æ­¥
                                goToNextStep();
                            } else {
                                // ç”¨æˆ·æ‹’ç»æˆæƒæˆ–æˆæƒå¤±è´¥
                                showToast('è·å–æ‰‹æœºå·å¤±è´¥ï¼š' + (data.errMsg || 'ç”¨æˆ·æ‹’ç»æˆæƒ'));
                            }
                        }
                    });
                } catch (error) {
                    console.error('å¾®ä¿¡å°ç¨‹åºAPIè°ƒç”¨å¤±è´¥', error);
                    showToast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } else {
                // éå°ç¨‹åºç¯å¢ƒï¼Œä½¿ç”¨åŸæœ‰çš„ç™»å½•æ–¹å¼
                const phone = prompt('è¯·è¾“å…¥æ‰‹æœºå·ç è¿›è¡Œç™»å½•ï¼š');
                if (!phone) return;
                
                try {
                    const response = await fetch('/api/wx/auth', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code: 'mock_web_code', // ç½‘é¡µç‰ˆä½¿ç”¨mock code
                            phone: phone
                        })
                    });
                    
                    const result = await response.json();
                    if (result.code === 0 && result.data && result.data.token) {
                        localStorage.setItem('aesthetic_token', result.data.token);
                        localStorage.setItem('aesthetic_token_expires', Date.now() + result.data.expires_in * 1000);
                    return true;
                    } else {
                        showToast('ç™»å½•å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                        return false;
                    }
                } catch (error) {
                    console.error('ç™»å½•è¯·æ±‚é”™è¯¯:', error);
                    showToast('ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                    return false;
                }
            }
        }
        
        // ç”Ÿæˆç”¨æˆ·IDçš„è¾…åŠ©å‡½æ•°
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // ä¿å­˜æŠ¥å‘Š
        function saveReport() {
            alert('æŠ¥å‘Šå·²ä¿å­˜');
        }

        // åˆ†äº«æŠ¥å‘Š
        function shareReport() {
            if (window.wx && window.wx.miniProgram) {
                // åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ï¼Œé€šçŸ¥å°ç¨‹åºè¿›è¡Œåˆ†äº«
                wx.miniProgram.postMessage({
                    data: {
                        type: 'shareReport'
                    }
                });
            } else {
                // åœ¨æµè§ˆå™¨ä¸­ï¼Œæ˜¾ç¤ºåˆ†äº«æç¤º
                showToast('åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­');
            }
        }
        
        // ç»§ç»­æµ‹è¯•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('continue-test-btn').addEventListener('click', function() {
            // ç›´æ¥åˆ·æ–°å½“å‰é¡µé¢
            window.location.reload();
        });

        // å›¾ç‰‡æ•°æ®
        {{ .image_string }}

        let currentCategory = 'clothing';
        let selectedImages = new Map();

        // åˆå§‹åŒ–å›¾ç‰‡é€‰æ‹©é¡µé¢
        function initImageSelection() {
            updateCategoryTabs();
            updateImageGrid();
            updateSelectedImages();
        }

        // æ›´æ–°ç±»åˆ«æ ‡ç­¾
        function updateCategoryTabs() {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === currentCategory);
            });
        }

        // æ›´æ–°å›¾ç‰‡ç½‘æ ¼
        function updateImageGrid() {
            const grid = document.querySelector('.image-grid');
            const images = imageData[currentCategory];
            
            grid.innerHTML = images.map(image => `
                <div class="image-item ${selectedImages.get(image.id) ? 'selected' : ''}" data-id="${image.id}">
                    <img src="${image.url}" alt="${image.categoryName}">
                    <div class="image-preview-btn">
                        <i class="fas fa-search-plus"></i>
                    </div>
                </div>
            `).join('');

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            grid.querySelectorAll('.image-item').forEach(item => {
                item.addEventListener('click', () => {
                    const imageId = item.dataset.id;
                    const image = imageData[currentCategory].find(img => img.id === imageId);
                    
                    if (selectedImages.has(imageId)) {
                        selectedImages.delete(imageId);
                        item.classList.remove('selected');
                    } else {
                        // ç§»é™¤åŒä¸€ç±»åˆ«çš„å…¶ä»–é€‰æ‹©
                        imageData[currentCategory].forEach(img => {
                            if (selectedImages.has(img.id)) {
                                selectedImages.delete(img.id);
                                document.querySelector(`.image-item[data-id="${img.id}"]`)?.classList.remove('selected');
                            }
                        });
                        
                        selectedImages.set(imageId, image);
                        item.classList.add('selected');
                    }
                    
                    updateSelectedImages();
                });
            });
        }

        // æ›´æ–°å·²é€‰å›¾ç‰‡å±•ç¤º
        function updateSelectedImages() {
            const container = document.querySelector('.selected-images-list');
            container.innerHTML = '';
            
            selectedImages.forEach((image, id) => {
                const item = document.createElement('div');
                item.className = 'selected-image-item';
                item.innerHTML = `
                    <img src="${image.url}" alt="${image.categoryName}">
                    <div class="selected-image-label">${image.categoryName}</div>
                    <div class="remove-image" data-id="${id}">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                
                item.querySelector('.remove-image').addEventListener('click', () => {
                    selectedImages.delete(id);
                    updateImageGrid();
                    updateSelectedImages();
                });
                
                container.appendChild(item);
            });
        }

        // äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentCategory = tab.dataset.category;
                updateCategoryTabs();
                updateImageGrid();
            });
        });

        // åˆå§‹åŒ–é¡µé¢
        initImageSelection();

        // å½¢å®¹è¯é€‰æ‹©é€»è¾‘
        let selectedAdjectives = new Set();

        // åˆå§‹åŒ–å½¢å®¹è¯é€‰æ‹©
        document.querySelectorAll('.adjective-item').forEach(item => {
            item.addEventListener('click', () => {
                const name = item.dataset.name;
                
                if (selectedAdjectives.has(name)) {
                    selectedAdjectives.delete(name);
                    item.classList.remove('selected');
                } else if (selectedAdjectives.size < 10) {
                    selectedAdjectives.add(name);
                    item.classList.add('selected');
                } else {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©10ä¸ªå½¢å®¹è¯');
                }
            });
        });

        // åœ¨é€‚å½“çš„åœ°æ–¹æ·»åŠ æ˜Ÿæ˜Ÿé—ªçƒæ•ˆæœ
        //setTimeout(addTwinkleEffect, 1000);
    </script>
    <!-- å¾®ä¿¡JS-SDKåˆå§‹åŒ– -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å°ç¨‹åºç¯å¢ƒä¸­
            function isMiniProgram() {
                return window.__wxjs_environment === 'miniprogram';
            }
            
        });
        // æ£€æµ‹æ˜¯å¦åœ¨å°ç¨‹åºç¯å¢ƒä¸­
        if (window.__wxjs_environment === 'miniprogram') {
        // å‘å°ç¨‹åºå‘é€æ¶ˆæ¯
        wx.miniProgram.postMessage({
            data: {
            action: 'someAction',
            value: 'someValue'
            }
        });
        
        // ç›‘å¬å°ç¨‹åºå‘æ¥çš„æ¶ˆæ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
        window.addEventListener('message', function(e) {
            console.log('æ”¶åˆ°å°ç¨‹åºæ¶ˆæ¯ï¼š', e.data);
        });
        }
    </script>
</body>
</html>